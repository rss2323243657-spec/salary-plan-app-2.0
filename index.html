<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    
    <!-- ===== PWA & æ‰‹æœº App åŒ– ===== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#2c5364">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è–ªé…¬è®¡åˆ’">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <title>å¤šæœˆä»½æ‰¹é‡æŸ¥çœ‹ + è‡ªå®šä¹‰æ˜ç»† + é€‰æ‹©æ€§æ‰¹é‡å¡«å…… è–ªé…¬è®¡åˆ’è¡¨</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5364, #203a43, #0f2027);
            color: #fff;
            padding: 28px;
            text-align: center;
        }

        .header h1 {
            font-size: 30px;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
            letter-spacing: 0.5px;
        }

        /* é€šç”¨æŠ˜å æ¨¡å—æ ·å¼ - å½»åº•é‡æ„ */
        .collapse-module {
            border-bottom: 1px solid #e9f0f5;
        }
        .collapse-header {
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            background-color: #f8fafc;
            position: relative;
        }
        .collapse-title {
            font-size: 16px;
            color: #2c5364;
            font-weight: 600;
        }
        /* æŠ˜å æŒ‰é’®ï¼šçº¯CSSç»˜åˆ¶å°ç®­å¤´ï¼Œå½»åº•è§£å†³å›¾æ ‡è¿‡å¤§é—®é¢˜ */
        .collapse-btn {
            width: 20px;
            height: 20px;
            background-color: #2c5364;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            z-index: 2;
            padding: 0;
            position: relative;
        }
        .collapse-btn:hover {
            background-color: #1a2a33;
            transform: scale(1.05);
        }
        /* çº¯CSSå°ç®­å¤´ */
        .collapse-btn::after {
            content: '';
            width: 6px;
            height: 6px;
            border-right: 1.5px solid #fff;
            border-bottom: 1.5px solid #fff;
            transform: rotate(45deg);
            transition: transform 0.3s ease;
        }
        .collapse-btn.collapsed::after {
            transform: rotate(-135deg);
        }
        .collapse-content {
            transition: all 0.3s ease;
            display: block;
        }
        .collapsed {
            display: none !important;
        }

        /* æ‰¹é‡æœˆä»½é€‰æ‹©é¢æ¿ï¼ˆæ”¯æŒè·¨å¹´ä»½ï¼‰ */
        .batch-filter {
            padding: 20px 30px;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            font-size: 14px;
            color: #2c5364;
            font-weight: 600;
        }

        .filter-item select, .filter-item input {
            padding: 10px 14px;
            border: 1px solid #dce6ed;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
            color: #333;
            background-color: #fff;
            min-width: 120px;
            transition: all 0.2s;
        }

        .filter-item select:focus, .filter-item input:focus {
            border-color: #2c5364;
            box-shadow: 0 0 0 2px rgba(44, 83, 100, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            padding: 10px 18px;
            background-color: #2c5364;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: #1a2a33;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .btn-add {
            background-color: #2e7d32;
        }

        .btn-add:hover {
            background-color: #1b5e20;
        }

        .btn-del {
            background-color: #c62828;
        }

        .btn-del:hover {
            background-color: #8e0000;
        }

        .btn-batch {
            background-color: #1976d2;
        }

        .btn-batch:hover {
            background-color: #0d47a1;
        }

        .btn-save {
            background-color: #f57f17;
        }

        .btn-save:hover {
            background-color: #e65100;
        }

        .btn-fillToPlan {
            background-color: #7b1fa2;
        }

        .btn-fillToPlan:hover {
            background-color: #4a148c;
        }

        .view-tip {
            font-size: 13px;
            color: #666;
            margin-left: auto;
            font-style: italic;
        }

        /* è‡ªå®šä¹‰æ˜ç»†é¢æ¿ */
        .custom-item-panel {
            padding: 15px 30px;
            background-color: #f0f4f8;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .custom-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-item input {
            width: 180px;
        }

        /* æ‰¹é‡å¡«å……é¢æ¿ */
        .batch-fill-panel {
            padding: 15px 30px;
            background-color: #e9f0f5;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .batch-fill-title {
            font-size: 14px;
            color: #2c5364;
            font-weight: 600;
        }

        /* å®é™…æ”¯å‡ºç¼–è¾‘é¢æ¿ */
        .actual-expense-panel {
            padding: 15px 30px;
            background-color: #fff8e1;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* è¡¨æ ¼åŒºåŸŸ */
        .table-section {
            padding: 30px;
        }

        .section-title {
            font-size: 20px;
            color: #2c5364;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2c5364;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background-color: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        th {
            background-color: #e9f0f5;
            color: #2c5364;
            padding: 14px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 2px solid #dce6ed;
            white-space: nowrap;
        }

        td {
            padding: 14px;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #f0f4f8;
            white-space: nowrap;
        }

        tr:hover {
            background-color: #f8fafc;
            transition: background-color 0.2s;
        }

        input[type="number"] {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #dce6ed;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
            color: #333;
            transition: all 0.2s;
        }

        input[type="number"]:focus {
            border-color: #2c5364;
            box-shadow: 0 0 0 2px rgba(44, 83, 100, 0.1);
            transform: translateY(-1px);
        }

        select {
            padding: 8px 12px;
            border: 1px solid #dce6ed;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
            color: #333;
            background-color: #fff;
            width: 120px;
            transition: all 0.2s;
        }

        select:focus {
            border-color: #2c5364;
            box-shadow: 0 0 0 2px rgba(44, 83, 100, 0.1);
            transform: translateY(-1px);
        }

        .total-row {
            background-color: #f0f4f8;
            font-weight: 600;
            color: #2c5364;
        }

        .core-item {
            background-color: #f8fafc;
        }

        .risk-red {
            background-color: #ffebee;
            color: #c62828;
            font-weight: 600;
        }

        .risk-yellow {
            background-color: #fff8e1;
            color: #f57f17;
            font-weight: 600;
        }

        .safe {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: 600;
        }

        .result-box {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            flex: 1;
            min-width: 250px;
            padding: 22px;
            background-color: #f8fafc;
            border-radius: 10px;
            border-left: 4px solid #2c5364;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .result-card h3 {
            font-size: 16px;
            color: #2c5364;
            margin-bottom: 12px;
        }

        .result-card .value {
            font-size: 26px;
            font-weight: 600;
            color: #333;
        }

        .result-card .desc {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        /* å¤šæœˆä»½æ±‡æ€»è¡¨æ ¼æ ·å¼ */
        .multi-month-table {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        /* æ˜ç»†é¡¹ç¼–è¾‘æ ·å¼ */
        .item-name-edit {
            border: none;
            background: transparent;
            font-size: 14px;
            color: #333;
            width: 100%;
            outline: none;
            cursor: text;
        }

        .item-name-edit:focus {
            border-bottom: 1px solid #2c5364;
        }

        /* å®é™…æ”¯å‡ºè¡¨æ ¼æ ·å¼ */
        .actual-expense-table td {
            background-color: #fff8e1;
        }
        
        /* ===== æ‰‹æœºç«¯ App ä½“éªŒå¾®è°ƒï¼ˆæ–°å¢ï¼‰ ===== */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container {
                max-width: 100%;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            input, select, button {
                font-size: 16px !important; /* é˜²æ­¢iOSç¼©æ”¾ */
                min-height: 44px; /* è§¦æ‘¸å‹å¥½ */
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 10px 8px;
            }
            .header h1 {
                font-size: 20px;
                padding: 0 10px;
            }
            .header p {
                font-size: 14px;
                padding: 0 10px;
            }
            .header {
                padding: 20px 15px;
            }
            .filter-item {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            .filter-item label {
                margin-bottom: 4px;
            }
            .filter-item select, .filter-item input {
                width: 100%;
            }
            .btn {
                padding: 12px 16px;
                font-size: 16px;
            }
            .result-box {
                flex-direction: column;
            }
            .result-card {
                min-width: 100%;
            }
        }
        
        /* ===== å®‰è£…æç¤ºï¼ˆæ–°å¢ï¼‰ ===== */
        #install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2c5364, #203a43);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        #install-prompt p {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        #install-prompt button {
            background-color: #fff;
            color: #2c5364;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        
        #install-prompt #close-prompt {
            background-color: transparent;
            color: #fff;
            border: 1px solid #fff;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- å®‰è£…æç¤ºæ¡† -->
    <div id="install-prompt">
        <p>ğŸ“± æ·»åŠ åˆ°ä¸»å±å¹•ï¼ŒåƒAppä¸€æ ·ä½¿ç”¨ï¼</p>
        <button id="install-btn">ç«‹å³å®‰è£…</button>
        <button id="close-prompt">ç¨åå†è¯´</button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>è–ªé…¬è®¡åˆ’è¡¨</h1>
            <p>è·¨å¹´ä»½æŸ¥çœ‹ | è‡ªå®šä¹‰æ˜ç»† | æ‰¹é‡å¡«å…… | æ•°æ®æœ¬åœ°ä¿å­˜</p>
        </div>

        <!-- 1. æ‰¹é‡æœˆä»½é€‰æ‹©é¢æ¿ï¼ˆæ”¯æŒè·¨å¹´ä»½ï¼‰ -->
        <div class="collapse-module">
            <div class="collapse-header" id="header-batchFilter">
                <div class="collapse-title">æ‰¹é‡æœˆä»½é€‰æ‹©ï¼ˆæ”¯æŒè·¨å¹´ä»½ï¼‰</div>
                <button class="collapse-btn" id="btn-batchFilter"></button>
            </div>
            <div class="collapse-content" id="content-batchFilter">
                <div class="batch-filter">
                    <div class="filter-item">
                        <label for="start-year">å¼€å§‹å¹´ä»½ï¼š</label>
                        <select id="start-year">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="start-month">å¼€å§‹æœˆä»½ï¼š</label>
                        <select id="start-month">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="end-year">ç»“æŸå¹´ä»½ï¼š</label>
                        <select id="end-year">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="end-month">ç»“æŸæœˆä»½ï¼š</label>
                        <select id="end-month">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12" selected>12æœˆ</option>
                        </select>
                    </div>
                    <button class="btn" id="btn-loadBatch">åŠ è½½æ‰¹é‡æœˆä»½æ•°æ®</button>
                    <button class="btn btn-save" id="btn-saveData">ä¿å­˜å½“å‰æ•°æ®</button>
                    <div class="view-tip" id="tip-batch">å½“å‰æ‰¹é‡æŸ¥çœ‹ï¼š2025å¹´1æœˆ - 2026å¹´12æœˆ æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- 2. æ‰¹é‡å¡«å……é¢æ¿ -->
        <div class="collapse-module">
            <div class="collapse-header" id="header-batchFill">
                <div class="collapse-title">å›ºå®šé¡¹é€‰æ‹©æ€§æ‰¹é‡å¡«å……</div>
                <button class="collapse-btn" id="btn-batchFill"></button>
            </div>
            <div class="collapse-content" id="content-batchFill">
                <div class="batch-fill-panel">
                    <div class="batch-fill-title">å›ºå®šé¡¹é€‰æ‹©æ€§æ‰¹é‡å¡«å……ï¼š</div>
                    <div class="custom-item">
                        <label>å¡«å……è§„åˆ™ï¼š</label>
                        <select id="select-fillRule">
                            <option value="all">æ‰€æœ‰æœˆä»½ï¼ˆç»Ÿä¸€é‡‘é¢ï¼‰</option>
                            <option value="odd-even">å•åŒæœˆï¼ˆå·®å¼‚åŒ–é‡‘é¢ï¼‰</option>
                            <option value="quarter">å­£åº¦ï¼ˆå·®å¼‚åŒ–é‡‘é¢ï¼‰</option>
                        </select>
                    </div>
                    <div class="custom-item" id="panel-all" style="display: flex;">
                        <label>ç»Ÿä¸€é‡‘é¢ï¼š</label>
                        <input type="number" id="input-all" placeholder="è¾“å…¥å¡«å……é‡‘é¢" min="0" step="0.01">
                    </div>
                    <div class="custom-item" id="panel-oddEven" style="display: none;">
                        <label>å•æœˆé‡‘é¢ï¼š</label>
                        <input type="number" id="input-odd" placeholder="å•æœˆé‡‘é¢" min="0" step="0.01">
                        <label>åŒæœˆé‡‘é¢ï¼š</label>
                        <input type="number" id="input-even" placeholder="åŒæœˆé‡‘é¢" min="0" step="0.01">
                    </div>
                    <div class="custom-item" id="panel-quarter" style="display: none;">
                        <label>1-3æœˆï¼š</label>
                        <input type="number" id="input-q1" placeholder="Q1é‡‘é¢" min="0" step="0.01">
                        <label>4-6æœˆï¼š</label>
                        <input type="number" id="input-q2" placeholder="Q2é‡‘é¢" min="0" step="0.01">
                        <label>7-9æœˆï¼š</label>
                        <input type="number" id="input-q3" placeholder="Q3é‡‘é¢" min="0" step="0.01">
                        <label>10-12æœˆï¼š</label>
                        <input type="number" id="input-q4" placeholder="Q4é‡‘é¢" min="0" step="0.01">
                    </div>
                    <button class="btn btn-batch" id="btn-doFill">æ‰§è¡Œæ‰¹é‡å¡«å……</button>
                    <span style="font-size:12px;color:#666;">ï¼ˆå…ˆé€‰ä¸­è¦å¡«å……çš„å›ºå®šæ˜ç»†è¡Œï¼Œå†é€‰æ‹©è§„åˆ™æ‰§è¡Œå¡«å……ï¼‰</span>
                </div>
            </div>
        </div>

        <!-- 3. è‡ªå®šä¹‰æ˜ç»†é¡¹é¢æ¿ -->
        <div class="collapse-module">
            <div class="collapse-header" id="header-customItem">
                <div class="collapse-title">è‡ªå®šä¹‰æ˜ç»†é¡¹ç®¡ç†</div>
                <button class="collapse-btn" id="btn-customItem"></button>
            </div>
            <div class="collapse-content" id="content-customItem">
                <div class="custom-item-panel">
                    <div class="custom-item">
                        <label>æ–°å¢æ˜ç»†ï¼š</label>
                        <select id="select-itemType">
                            <option value="income">æ”¶å…¥é¡¹</option>
                            <option value="expense">æ”¯å‡ºé¡¹</option>
                            <option value="debt">è´Ÿå€ºé¡¹</option>
                        </select>
                        <input type="text" id="input-itemName" placeholder="è¾“å…¥æ˜ç»†åç§°ï¼ˆå¦‚ï¼šå¹´ç»ˆå¥–ï¼‰">
                        <select id="select-itemFixed">
                            <option value="å›ºå®š">å›ºå®š</option>
                            <option value="éå›ºå®š">éå›ºå®š</option>
                        </select>
                        <button class="btn btn-add" id="btn-addItem">æ·»åŠ æ˜ç»†</button>
                    </div>
                    <div class="custom-item">
                        <label>åˆ é™¤é€‰ä¸­æ˜ç»†ï¼š</label>
                        <button class="btn btn-del" id="btn-delItem">åˆ é™¤æ˜ç»†</button>
                        <span style="font-size:12px;color:#666;">ï¼ˆç‚¹å‡»æ˜ç»†è¡Œé€‰ä¸­ååˆ é™¤ï¼‰</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-section">
            <!-- 4. å¤šæœˆä»½æ˜ç»†æ±‡æ€»è¡¨ -->
            <div class="collapse-module">
                <div class="collapse-header" id="header-summaryTable">
                    <div class="collapse-title">å¤šæœˆä»½æ˜ç»†æ±‡æ€»è¡¨ï¼ˆæ”¶å…¥/æ”¯å‡º/è´Ÿå€ºåˆå¹¶ï¼‰</div>
                    <button class="collapse-btn" id="btn-summaryTable"></button>
                </div>
                <div class="collapse-content" id="content-summaryTable">
                    <div class="section-title">
                        <span>ä¸€ã€å¤šæœˆä»½æ˜ç»†æ±‡æ€»è¡¨ï¼ˆæ”¶å…¥/æ”¯å‡º/è´Ÿå€ºåˆå¹¶ï¼‰</span>
                        <span style="font-size:14px;color:#666;">ç‚¹å‡»æ˜ç»†åç§°å¯ç›´æ¥ä¿®æ”¹ | å›ºå®šé¡¹æ”¯æŒæ‰¹é‡å¡«å……</span>
                    </div>
                    <div class="multi-month-table">
                        <table id="table-summary">
                            <thead>
                                <tr id="tr-monthTh">
                                    <th>æ˜ç»†ç±»å‹</th>
                                    <th>æ˜ç»†åç§°</th>
                                    <th>å›ºå®š/éå›ºå®š</th>
                                    <!-- æœˆä»½åˆ—åŠ¨æ€ç”Ÿæˆï¼ˆæ ¼å¼ï¼šå¹´-æœˆï¼‰ -->
                                    <th>æ‰¹é‡æ€»è®¡</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-items">
                                <!-- åŠ¨æ€ç”Ÿæˆæ˜ç»†è¡Œ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. å®é™…æ”¯å‡ºç¼–è¾‘é¢æ¿ï¼ˆç§»åˆ°æ±‡æ€»è¡¨ä¸‹æ–¹ï¼‰ -->
            <div class="collapse-module">
                <div class="collapse-header" id="header-actualExpense">
                    <div class="collapse-title">éå›ºå®šé¡¹å®é™…æ”¯å‡ºç¼–è¾‘ï¼ˆå¯¹æ¯”+ä¸€é”®å¡«å……ï¼‰</div>
                    <button class="collapse-btn" id="btn-actualExpense"></button>
                </div>
                <div class="collapse-content" id="content-actualExpense">
                    <div class="actual-expense-panel">
                        <div class="batch-fill-title">é€‰æ‹©æœˆä»½ç¼–è¾‘éå›ºå®šé¡¹å®é™…æ”¯å‡ºï¼š</div>
                        <div class="custom-item">
                            <select id="select-editMonth" disabled>
                                <option value="">è¯·å…ˆåŠ è½½æœˆä»½æ•°æ®</option>
                            </select>
                            <button class="btn" id="btn-loadEditMonth">åŠ è½½è¯¥æœˆæ•°æ®</button>
                            <button class="btn btn-fillToPlan" id="btn-fillToPlan">ä¸€é”®å¡«å……åˆ°è§„åˆ’è¡¨</button>
                        </div>
                        <span style="font-size:12px;color:#666;">ï¼ˆåŠ è½½åç¼–è¾‘å®é™…æ”¯å‡ºï¼Œå¡«å……ååŒæ­¥åˆ°å¯¹åº”å¹´æœˆè§„åˆ’æ•°æ®ï¼‰</span>
                    </div>
                    <div class="table-section">
                        <div class="section-title">
                            <span>è¯¥æœˆéå›ºå®šé¡¹æ˜ç»†ï¼ˆè§„åˆ’ vs å®é™…ï¼‰</span>
                        </div>
                        <div class="multi-month-table">
                            <table id="table-actualExpense" class="actual-expense-table">
                                <thead>
                                    <tr>
                                        <th>æ˜ç»†ç±»å‹</th>
                                        <th>æ˜ç»†åç§°</th>
                                        <th>è§„åˆ’é‡‘é¢</th>
                                        <th>å®é™…é‡‘é¢</th>
                                        <th>åå·®é‡‘é¢ï¼ˆå®é™…-è§„åˆ’ï¼‰</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-actualExpense">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: #666;">è¯·å…ˆé€‰æ‹©æœˆä»½å¹¶åŠ è½½æ•°æ®</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. å¤šæœˆä»½æ”¶æ”¯ç»“ä½™æ±‡æ€» -->
            <div class="collapse-module">
                <div class="collapse-header" id="header-balanceTable">
                    <div class="collapse-title">å¤šæœˆä»½æ”¶æ”¯ç»“ä½™æ±‡æ€»</div>
                    <button class="collapse-btn" id="btn-balanceTable"></button>
                </div>
                <div class="collapse-content" id="content-balanceTable">
                    <div class="section-title">äºŒã€å¤šæœˆä»½æ”¶æ”¯ç»“ä½™æ±‡æ€»</div>
                    <div class="multi-month-table">
                        <table id="table-balance">
                            <thead>
                                <tr id="tr-balanceTh">
                                    <th>ç»Ÿè®¡é¡¹ç›®</th>
                                    <!-- æœˆä»½åˆ—åŠ¨æ€ç”Ÿæˆï¼ˆæ ¼å¼ï¼šå¹´-æœˆï¼‰ -->
                                    <th>æ‰¹é‡æ€»è®¡</th>
                                    <th>çŠ¶æ€æç¤º</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-balance">
                                <tr id="tr-income">
                                    <td>æ€»æ”¶å…¥</td>
                                    <!-- æœˆä»½åˆ—åŠ¨æ€å¡«å…… -->
                                    <td id="td-totalIncome">0.00</td>
                                    <td>-</td>
                                </tr>
                                <tr id="tr-expense">
                                    <td>æ€»æ”¯å‡º</td>
                                    <!-- æœˆä»½åˆ—åŠ¨æ€å¡«å…… -->
                                    <td id="td-totalExpense">0.00</td>
                                    <td>-</td>
                                </tr>
                                <tr id="tr-debt">
                                    <td>æ€»è´Ÿå€ºè¿˜æ¬¾</td>
                                    <!-- æœˆä»½åˆ—åŠ¨æ€å¡«å…… -->
                                    <td id="td-totalDebt">0.00</td>
                                    <td>-</td>
                                </tr>
                                <tr class="core-item" id="tr-balance">
                                    <td>æ”¶æ”¯ç»“ä½™ï¼ˆæ”¶å…¥-æ”¯å‡ºï¼‰</td>
                                    <!-- æœˆä»½åˆ—åŠ¨æ€å¡«å…… -->
                                    <td id="td-balance">0.00</td>
                                    <td id="td-balanceStatus">--</td>
                                </tr>
                                <tr class="core-item" id="tr-disposable">
                                    <td>æœ€ç»ˆå¯æ”¯é…ä½™é¢ï¼ˆç»“ä½™-è´Ÿå€ºï¼‰</td>
                                    <!-- æœˆä»½åˆ—åŠ¨æ€å¡«å…… -->
                                    <td id="td-disposable">0.00</td>
                                    <td id="td-disposableStatus">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 7. å¯è§†åŒ–ç»“æœå¡ç‰‡ -->
            <div class="collapse-module">
                <div class="collapse-header" id="header-resultCard">
                    <div class="collapse-title">æ•°æ®å¯è§†åŒ–æ±‡æ€»å¡ç‰‡</div>
                    <button class="collapse-btn" id="btn-resultCard"></button>
                </div>
                <div class="collapse-content" id="content-resultCard">
                    <div class="result-box">
                        <div class="result-card">
                            <h3>æ‰¹é‡æ€»æ”¶â¼Š</h3>
                            <div class="value" id="card-income">Â¥ 0.00</div>
                            <div class="desc">æ‰€é€‰æœˆä»½æ”¶å…¥æ€»å’Œ</div>
                        </div>
                        <div class="result-card">
                            <h3>æ‰¹é‡æ€»â½€å‡º</h3>
                            <div class="value" id="card-expense">Â¥ 0.00</div>
                            <div class="desc">æ‰€é€‰æœˆä»½æ”¯å‡ºæ€»å’Œ</div>
                        </div>
                        <div class="result-card">
                            <h3>æ‰¹é‡æ€»è´Ÿå€º</h3>
                            <div class="value" id="card-debt">Â¥ 0.00</div>
                            <div class="desc">æ‰€é€‰æœˆä»½è´Ÿå€ºè¿˜æ¬¾æ€»å’Œ</div>
                        </div>
                        <div class="result-card">
                            <h3>æ‰¹é‡æœ€ç»ˆå¯æ”¯é…ä½™é¢</h3>
                            <div class="value" id="card-disposable">Â¥ 0.00</div>
                            <div class="desc">æ‰€é€‰æœˆä»½å¯è‡ªç”±æ”¯é…èµ„é‡‘æ€»å’Œ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç§»åŠ¨ç«¯å¿«æ·æ“ä½œæ ï¼ˆæ–°å¢ï¼‰ -->
        <div style="display: none;" id="mobile-toolbar">
            <div style="display: flex; justify-content: space-around; padding: 10px; background: #f5f7fa; border-top: 1px solid #ddd;">
                <button class="btn" onclick="document.getElementById('btn-saveData').click()">ğŸ’¾ ä¿å­˜</button>
                <button class="btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">â¬†ï¸ é¡¶éƒ¨</button>
                <button class="btn" onclick="showInstallPrompt()">ğŸ“± å®‰è£…</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€é…ç½®ï¼ˆæ”¯æŒè·¨å¹´ä»½ï¼Œæ–°å¢å®é™…æ”¯å‡ºå­˜å‚¨ï¼‰
        let globalConfig = {
            startYear: "2025",
            endYear: "2026",
            startMonth: 1,
            endMonth: 12,
            months: [], // æ ¼å¼ï¼š["2025-01", "2025-02", ..., "2026-12"]
            itemTypes: {
                income: { name: "æ”¶å…¥", items: [
                    { id: "in1", name: "åŸºæœ¬å·¥èµ„", isFixed: "å›ºå®š", planValues: {}, actualValues: {} },
                    { id: "in2", name: "å›ºå®šè¡¥è´´ï¼ˆé¤è¡¥/äº¤é€šè¡¥ï¼‰", isFixed: "å›ºå®š", planValues: {}, actualValues: {} },
                    { id: "in3", name: "ç»©æ•ˆå¥–é‡‘", isFixed: "éå›ºå®š", planValues: {}, actualValues: {} },
                    { id: "in4", name: "é”€å”®ææˆ", isFixed: "éå›ºå®š", planValues: {}, actualValues: {} },
                    { id: "in5", name: "å¹´ç»ˆå¥–é‡‘ï¼ˆå‡æ‘Šæœˆåº¦ï¼‰", isFixed: "éå›ºå®š", planValues: {}, actualValues: {} }
                ]},
                expense: { name: "æ”¯å‡º", items: [
                    { id: "ex1", name: "æˆ¿ç§Ÿ/æˆ¿è´·æœˆä¾›", isFixed: "å›ºå®š", planValues: {}, actualValues: {} },
                    { id: "ex2", name: "æ°´ç”µç‡ƒæ°”è´¹", isFixed: "å›ºå®š", planValues: {}, actualValues: {} },
                    { id: "ex3", name: "äº”é™©ä¸€é‡‘ä¸ªäººç¼´çº³", isFixed: "å›ºå®š", planValues: {}, actualValues: {} },
                    { id: "ex4", name: "é¤é¥®å¨±ä¹", isFixed: "éå›ºå®š", planValues: {}, actualValues: {} },
                    { id: "ex5", name: "è´­ç‰©æ¶ˆè´¹", isFixed: "éå›ºå®š", planValues: {}, actualValues: {} }
                ]},
                debt: { name: "è´Ÿå€º", items: [
                    { id: "dt1", name: "è½¦è´·æœˆä¾›", isFixed: "å›ºå®š", planValues: {}, actualValues: {} },
                    { id: "dt2", name: "ä¿¡ç”¨å¡å›ºå®šè¿˜æ¬¾", isFixed: "å›ºå®š", planValues: {}, actualValues: {} },
                    { id: "dt3", name: "ä¸´æ—¶ä¿¡ç”¨å¡è´¦å•", isFixed: "éå›ºå®š", planValues: {}, actualValues: {} }
                ]}
            },
            currentEditMonth: "" // å½“å‰ç¼–è¾‘çš„æœˆä»½ï¼ˆæ ¼å¼ï¼šå¹´-æœˆï¼‰
        };

        // æŠ˜å æ¨¡å—é…ç½®ï¼ˆè°ƒæ•´å®é™…æ”¯å‡ºé¢æ¿ä½ç½®ï¼‰
        const collapseModules = [
            { headerId: "header-batchFilter", btnId: "btn-batchFilter", contentId: "content-batchFilter" },
            { headerId: "header-batchFill", btnId: "btn-batchFill", contentId: "content-batchFill" },
            { headerId: "header-customItem", btnId: "btn-customItem", contentId: "content-customItem" },
            { headerId: "header-summaryTable", btnId: "btn-summaryTable", contentId: "content-summaryTable" },
            { headerId: "header-actualExpense", btnId: "btn-actualExpense", contentId: "content-actualExpense" },
            { headerId: "header-balanceTable", btnId: "btn-balanceTable", contentId: "content-balanceTable" },
            { headerId: "header-resultCard", btnId: "btn-resultCard", contentId: "content-resultCard" }
        ];

        // åˆå§‹åŒ–æœˆä»½æ•°ç»„ï¼ˆæ”¯æŒè·¨å¹´ä»½ï¼‰
        function initMonths() {
            globalConfig.months = [];
            let startY = parseInt(globalConfig.startYear);
            let endY = parseInt(globalConfig.endYear);
            let startM = globalConfig.startMonth;
            let endM = globalConfig.endMonth;

            // éå†å¹´ä»½
            for (let y = startY; y <= endY; y++) {
                // ç¡®å®šå½“å‰å¹´çš„å¼€å§‹å’Œç»“æŸæœˆä»½
                let curStartM = (y === startY) ? startM : 1;
                let curEndM = (y === endY) ? endM : 12;
                // éå†å½“å‰å¹´çš„æœˆä»½
                for (let m = curStartM; m <= curEndM; m++) {
                    let monthKey = `${y}-${m.toString().padStart(2, "0")}`;
                    globalConfig.months.push(monthKey);
                }
            }

            // åˆå§‹åŒ–æ˜ç»†é¡¹çš„è§„åˆ’å€¼å’Œå®é™…å€¼
            const allItems = [
                ...globalConfig.itemTypes.income.items,
                ...globalConfig.itemTypes.expense.items,
                ...globalConfig.itemTypes.debt.items
            ];
            allItems.forEach(item => {
                globalConfig.months.forEach(monthKey => {
                    if (!item.planValues[monthKey]) item.planValues[monthKey] = "";
                    if (!item.actualValues[monthKey]) item.actualValues[monthKey] = "";
                });
            });

            // æ›´æ–°æœˆä»½é€‰æ‹©ä¸‹æ‹‰æ¡†
            updateEditMonthSelect();
        }

        // æ ¼å¼åŒ–æ•°å­—ä¸ºä¸¤ä½å°æ•°
        function formatNum(num) {
            return parseFloat(num || 0).toFixed(2);
        }

        // åˆ‡æ¢æŠ˜å çŠ¶æ€
        function toggleCollapse(contentId, btnId) {
            const content = document.getElementById(contentId);
            const btn = document.getElementById(btnId);
            if (!content || !btn) return;
            
            const isCollapsed = content.classList.contains("collapsed");
            if (isCollapsed) {
                content.classList.remove("collapsed");
                btn.classList.remove("collapsed");
            } else {
                content.classList.add("collapsed");
                btn.classList.add("collapsed");
            }
        }

        // æ›´æ–°æ‰¹é‡æç¤ºæ–‡æœ¬ï¼ˆè·¨å¹´ä»½ï¼‰
        function updateBatchTip() {
            const startYear = document.getElementById("start-year").value;
            const startMonth = document.getElementById("start-month").value;
            const endYear = document.getElementById("end-year").value;
            const endMonth = document.getElementById("end-month").value;
            const startText = `${startYear}å¹´${document.getElementById("start-month").options[startMonth-1].text}`;
            const endText = `${endYear}å¹´${document.getElementById("end-month").options[endMonth-1].text}`;
            document.getElementById("tip-batch").textContent = `å½“å‰æ‰¹é‡æŸ¥çœ‹ï¼š${startText} - ${endText} æ•°æ®`;
        }

        // åˆ‡æ¢å¡«å……é‡‘é¢é¢æ¿
        function switchFillPanel() {
            const rule = document.getElementById("select-fillRule").value;
            const panelAll = document.getElementById("panel-all");
            const panelOddEven = document.getElementById("panel-oddEven");
            const panelQuarter = document.getElementById("panel-quarter");

            panelAll.style.display = "none";
            panelOddEven.style.display = "none";
            panelQuarter.style.display = "none";

            if (rule === "all") panelAll.style.display = "flex";
            else if (rule === "odd-even") panelOddEven.style.display = "flex";
            else if (rule === "quarter") panelQuarter.style.display = "flex";
        }

        // æ›´æ–°å®é™…æ”¯å‡ºç¼–è¾‘çš„æœˆä»½é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateEditMonthSelect() {
            const select = document.getElementById("select-editMonth");
            select.innerHTML = "";
            if (globalConfig.months.length === 0) {
                select.innerHTML = "<option value=''>è¯·å…ˆåŠ è½½æœˆä»½æ•°æ®</option>";
                select.disabled = true;
                return;
            }
            globalConfig.months.forEach(monthKey => {
                const option = document.createElement("option");
                option.value = monthKey;
                option.textContent = monthKey.replace("-", "å¹´") + "æœˆ";
                select.appendChild(option);
            });
            select.disabled = false;
        }

        // ç”Ÿæˆæœˆä»½è¡¨å¤´å’Œç»“ä½™è¡¨æœˆä»½åˆ—ï¼ˆè·¨å¹´ä»½æ ¼å¼ï¼šå¹´-æœˆï¼‰
        function generateMonthColumns() {
            // æ¸…ç©ºåŸæœ‰æœˆä»½åˆ—
            document.querySelectorAll(".month-col").forEach(el => el.remove());

            // ç”Ÿæˆæ±‡æ€»è¡¨æœˆä»½è¡¨å¤´
            const monthTr = document.getElementById("tr-monthTh");
            // ç”Ÿæˆç»“ä½™è¡¨æœˆä»½è¡¨å¤´
            const balanceTr = document.getElementById("tr-balanceTh");
            // ç”Ÿæˆç»“ä½™è¡¨æ•°æ®åˆ—
            const balanceRows = document.querySelectorAll("#tbody-balance tr");

            globalConfig.months.forEach(monthKey => {
                const monthText = monthKey.replace("-", "å¹´") + "æœˆ";

                // æ±‡æ€»è¡¨è¡¨å¤´
                const th1 = document.createElement("th");
                th1.className = "month-col";
                th1.textContent = monthText;
                monthTr.insertBefore(th1, monthTr.querySelector("th:nth-last-child(2)"));

                // ç»“ä½™è¡¨è¡¨å¤´
                const th2 = document.createElement("th");
                th2.className = "month-col";
                th2.textContent = monthText;
                balanceTr.insertBefore(th2, balanceTr.querySelector("th:nth-last-child(2)"));

                // ç»“ä½™è¡¨æ•°æ®åˆ—
                balanceRows.forEach(tr => {
                    const td = document.createElement("td");
                    td.className = "month-col";
                    td.textContent = "0.00";
                    tr.insertBefore(td, tr.querySelector("td:nth-last-child(2)"));
                });
            });
        }

        // ç”Ÿæˆæ˜ç»†è¡Œï¼ˆè§„åˆ’å€¼ï¼‰
        function generateItemRows() {
            const tbody = document.getElementById("tbody-items");
            tbody.innerHTML = "";

            for (const typeKey in globalConfig.itemTypes) {
                const type = globalConfig.itemTypes[typeKey];
                type.items.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.dataset.id = item.id;
                    tr.dataset.type = typeKey;
                    tr.style.backgroundColor = item.isFixed === "å›ºå®š" ? "#f0f8fb" : "";

                    // è¡Œé€‰ä¸­äº‹ä»¶
                    tr.onclick = function() {
                        document.querySelectorAll("#tbody-items tr").forEach(t => {
                            t.style.backgroundColor = t.dataset.type ? (t.dataset.isFixed === "å›ºå®š" ? "#f0f8fb" : "") : "";
                        });
                        this.style.backgroundColor = "#e9f0f5";
                    };

                    // æ˜ç»†ç±»å‹åˆ—
                    const td1 = document.createElement("td");
                    td1.textContent = type.name;
                    tr.appendChild(td1);

                    // æ˜ç»†åç§°åˆ—ï¼ˆå¯ç¼–è¾‘ï¼‰
                    const td2 = document.createElement("td");
                    const nameInput = document.createElement("input");
                    nameInput.className = "item-name-edit";
                    nameInput.value = item.name;
                    nameInput.onblur = function() {
                        item.name = this.value.trim() || "æœªå‘½åæ˜ç»†";
                        this.value = item.name;
                        // æ›´æ–°å®é™…æ”¯å‡ºè¡¨æ ¼
                        if (globalConfig.currentEditMonth) loadActualExpenseTable();
                    };
                    td2.appendChild(nameInput);
                    tr.appendChild(td2);

                    // å›ºå®š/éå›ºå®šåˆ—
                    const td3 = document.createElement("td");
                    const fixedSelect = document.createElement("select");
                    fixedSelect.innerHTML = `<option value="å›ºå®š" ${item.isFixed === "å›ºå®š" ? "selected" : ""}>å›ºå®š</option><option value="éå›ºå®š" ${item.isFixed === "éå›ºå®š" ? "selected" : ""}>éå›ºå®š</option>`;
                    fixedSelect.onchange = function() {
                        item.isFixed = this.value;
                        tr.style.backgroundColor = item.isFixed === "å›ºå®š" ? "#f0f8fb" : "";
                        generateItemRows();
                        // æ›´æ–°å®é™…æ”¯å‡ºè¡¨æ ¼ï¼ˆåˆ‡æ¢å›ºå®š/éå›ºå®šååˆ·æ–°ï¼‰
                        if (globalConfig.currentEditMonth) loadActualExpenseTable();
                    };
                    td3.appendChild(fixedSelect);
                    tr.appendChild(td3);

                    // æœˆä»½è§„åˆ’å€¼åˆ—
                    globalConfig.months.forEach(monthKey => {
                        const td = document.createElement("td");
                        const input = document.createElement("input");
                        input.type = "number";
                        input.min = 0;
                        input.step = 0.01;
                        input.value = item.planValues[monthKey] || "";
                        input.oninput = function() {
                            item.planValues[monthKey] = parseFloat(this.value || 0);
                            calculateAll();
                            // æ›´æ–°å®é™…æ”¯å‡ºè¡¨æ ¼ï¼ˆè‹¥å½“å‰ç¼–è¾‘è¯¥æœˆï¼‰
                            if (globalConfig.currentEditMonth === monthKey) loadActualExpenseTable();
                        };
                        td.appendChild(input);
                        tr.appendChild(td);
                    });

                    // æ‰¹é‡æ€»è®¡åˆ—
                    const totalTd = document.createElement("td");
                    const total = globalConfig.months.reduce((sum, monthKey) => sum + parseFloat(item.planValues[monthKey] || 0), 0);
                    totalTd.textContent = formatNum(total);
                    tr.appendChild(totalTd);

                    // æ“ä½œåˆ—
                    const opTd = document.createElement("td");
                    const delBtn = document.createElement("button");
                    delBtn.className = "btn btn-del";
                    delBtn.style.padding = "4px 8px";
                    delBtn.style.fontSize = "12px";
                    delBtn.textContent = "åˆ é™¤";
                    delBtn.onclick = function(e) {
                        e.stopPropagation();
                        deleteItem(item.id, typeKey, item.name);
                    };
                    opTd.appendChild(delBtn);
                    tr.appendChild(opTd);

                    tbody.appendChild(tr);
                });
            }
        }

        // ç”Ÿæˆå®é™…æ”¯å‡ºè¡¨æ ¼ï¼ˆä»…æ˜¾ç¤ºéå›ºå®šé¡¹ï¼‰
        function loadActualExpenseTable() {
            const monthKey = globalConfig.currentEditMonth;
            const tbody = document.getElementById("tbody-actualExpense");
            tbody.innerHTML = "";

            if (!monthKey || !globalConfig.months.includes(monthKey)) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="5" style="text-align: center; color: #666;">è¯·å…ˆé€‰æ‹©æœˆä»½å¹¶åŠ è½½æ•°æ®</td>`;
                tbody.appendChild(tr);
                return;
            }

            // ç­›é€‰æ‰€æœ‰éå›ºå®šé¡¹
            const nonFixedItems = [];
            for (const typeKey in globalConfig.itemTypes) {
                const type = globalConfig.itemTypes[typeKey];
                const items = type.items.filter(item => item.isFixed === "éå›ºå®š");
                items.forEach(item => {
                    nonFixedItems.push({ ...item, typeName: type.name, typeKey: typeKey });
                });
            }

            if (nonFixedItems.length === 0) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="5" style="text-align: center; color: #666;">æš‚æ— éå›ºå®šé¡¹æ˜ç»†</td>`;
                tbody.appendChild(tr);
                return;
            }

            // ç”Ÿæˆéå›ºå®šé¡¹æ˜ç»†è¡Œ
            nonFixedItems.forEach(item => {
                const tr = document.createElement("tr");
                const planVal = parseFloat(item.planValues[monthKey] || 0);
                const actualVal = parseFloat(item.actualValues[monthKey] || 0);
                const diffVal = actualVal - planVal;

                // æ˜ç»†ç±»å‹åˆ—
                const td1 = document.createElement("td");
                td1.textContent = item.typeName;
                tr.appendChild(td1);

                // æ˜ç»†åç§°åˆ—
                const td2 = document.createElement("td");
                td2.textContent = item.name;
                tr.appendChild(td2);

                // è§„åˆ’é‡‘é¢åˆ—
                const td3 = document.createElement("td");
                td3.textContent = formatNum(planVal);
                tr.appendChild(td3);

                // å®é™…é‡‘é¢ï¼ˆå¯ç¼–è¾‘ï¼‰
                const td4 = document.createElement("td");
                const input = document.createElement("input");
                input.type = "number";
                input.min = 0;
                input.step = 0.01;
                input.value = formatNum(actualVal);
                input.oninput = function() {
                    item.actualValues[monthKey] = parseFloat(this.value || 0);
                    // æ›´æ–°åå·®é‡‘é¢
                    const newDiff = parseFloat(this.value || 0) - planVal;
                    td5.textContent = formatNum(newDiff);
                    // æ ‡è®°åå·®æ ·å¼
                    if (newDiff > 0) {
                        td5.style.color = "#c62828";
                        td5.style.fontWeight = "600";
                    } else if (newDiff < 0) {
                        td5.style.color = "#2e7d32";
                        td5.style.fontWeight = "600";
                    } else {
                        td5.style.color = "#333";
                        td5.style.fontWeight = "normal";
                    }
                };
                td4.appendChild(input);
                tr.appendChild(td4);

                // åå·®é‡‘é¢
                const td5 = document.createElement("td");
                td5.textContent = formatNum(diffVal);
                if (diffVal > 0) {
                    td5.style.color = "#c62828";
                    td5.style.fontWeight = "600";
                } else if (diffVal < 0) {
                    td5.style.color = "#2e7d32";
                    td5.style.fontWeight = "600";
                }
                tr.appendChild(td5);

                tbody.appendChild(tr);
            });

            // æ·»åŠ æ€»è®¡è¡Œ
            const totalTr = document.createElement("tr");
            totalTr.className = "total-row";
            const totalPlan = nonFixedItems.reduce((sum, item) => sum + parseFloat(item.planValues[monthKey] || 0), 0);
            const totalActual = nonFixedItems.reduce((sum, item) => sum + parseFloat(item.actualValues[monthKey] || 0), 0);
            const totalDiff = totalActual - totalPlan;

            totalTr.innerHTML = `
                <td>æ€»è®¡</td>
                <td>-</td>
                <td>${formatNum(totalPlan)}</td>
                <td>${formatNum(totalActual)}</td>
                <td style="${totalDiff > 0 ? 'color: #c62828; font-weight: 600;' : totalDiff < 0 ? 'color: #2e7d32; font-weight: 600;' : 'color: #333;'}">${formatNum(totalDiff)}</td>
            `;
            tbody.appendChild(totalTr);
        }

        // ä¸€é”®å¡«å……å®é™…æ”¯å‡ºåˆ°è§„åˆ’è¡¨å¯¹åº”å¹´æœˆ
        function fillActualToPlan() {
            const monthKey = globalConfig.currentEditMonth;
            if (!monthKey || !globalConfig.months.includes(monthKey)) {
                alert("è¯·å…ˆåŠ è½½è¦å¡«å……çš„æœˆä»½å®é™…æ”¯å‡ºæ•°æ®ï¼");
                return;
            }

            // ç­›é€‰æ‰€æœ‰éå›ºå®šé¡¹
            const nonFixedItems = [];
            for (const typeKey in globalConfig.itemTypes) {
                const type = globalConfig.itemTypes[typeKey];
                const items = type.items.filter(item => item.isFixed === "éå›ºå®š");
                nonFixedItems.push(...items);
            }

            if (nonFixedItems.length === 0) {
                alert("æš‚æ— éå›ºå®šé¡¹å¯å¡«å……ï¼");
                return;
            }

            // åŒæ­¥å®é™…å€¼åˆ°è§„åˆ’å€¼
            nonFixedItems.forEach(item => {
                item.planValues[monthKey] = parseFloat(item.actualValues[monthKey] || 0);
            });

            // åˆ·æ–°è¡¨æ ¼å’Œç»Ÿè®¡æ•°æ®
            generateItemRows();
            calculateAll();
            alert(`å·²å°†ã€${monthKey.replace("-", "å¹´")}æœˆã€‘çš„éå›ºå®šé¡¹å®é™…æ”¯å‡ºä¸€é”®å¡«å……åˆ°è§„åˆ’è¡¨ï¼`);
        }

        // è®¡ç®—æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼ˆè§„åˆ’å€¼ï¼‰
        function calculateAll() {
            // 1. è®¡ç®—æ¯ä¸ªæ˜ç»†é¡¹è§„åˆ’å€¼æ€»è®¡
            document.querySelectorAll("#tbody-items tr").forEach(tr => {
                const itemId = tr.dataset.id;
                const typeKey = tr.dataset.type;
                const item = globalConfig.itemTypes[typeKey].items.find(i => i.id === itemId);
                if (!item) return;

                const total = globalConfig.months.reduce((sum, monthKey) => sum + parseFloat(item.planValues[monthKey] || 0), 0);
                tr.querySelector("td:nth-last-child(2)").textContent = formatNum(total);
            });

            // 2. è®¡ç®—æœˆä»½ç»Ÿè®¡å’Œæ‰¹é‡æ€»è®¡
            const monthStats = {};
            let totalIncome = 0, totalExpense = 0, totalDebt = 0, totalBalance = 0, totalDisposable = 0;

            // åˆå§‹åŒ–æœˆä»½ç»Ÿè®¡
            globalConfig.months.forEach(monthKey => {
                monthStats[monthKey] = { income: 0, expense: 0, debt: 0, balance: 0, disposable: 0 };
            });

            // æ”¶å…¥ç»Ÿè®¡
            globalConfig.itemTypes.income.items.forEach(item => {
                globalConfig.months.forEach(monthKey => {
                    monthStats[monthKey].income += parseFloat(item.planValues[monthKey] || 0);
                });
            });

            // æ”¯å‡ºç»Ÿè®¡
            globalConfig.itemTypes.expense.items.forEach(item => {
                globalConfig.months.forEach(monthKey => {
                    monthStats[monthKey].expense += parseFloat(item.planValues[monthKey] || 0);
                });
            });

            // è´Ÿå€ºç»Ÿè®¡
            globalConfig.itemTypes.debt.items.forEach(item => {
                globalConfig.months.forEach(monthKey => {
                    monthStats[monthKey].debt += parseFloat(item.planValues[monthKey] || 0);
                });
            });

            // è®¡ç®—ç»“ä½™å’Œæ‰¹é‡æ€»è®¡
            globalConfig.months.forEach(monthKey => {
                monthStats[monthKey].balance = monthStats[monthKey].income - monthStats[monthKey].expense;
                monthStats[monthKey].disposable = monthStats[monthKey].balance - monthStats[monthKey].debt;

                totalIncome += monthStats[monthKey].income;
                totalExpense += monthStats[monthKey].expense;
                totalDebt += monthStats[monthKey].debt;
                totalBalance += monthStats[monthKey].balance;
                totalDisposable += monthStats[monthKey].disposable;
            });

            // 3. æ›´æ–°ç»“ä½™è¡¨æ•°æ®
            const incomeRow = document.getElementById("tr-income");
            const expenseRow = document.getElementById("tr-expense");
            const debtRow = document.getElementById("tr-debt");
            const balanceRow = document.getElementById("tr-balance");
            const disposableRow = document.getElementById("tr-disposable");

            const incomeTds = incomeRow.querySelectorAll(".month-col");
            const expenseTds = expenseRow.querySelectorAll(".month-col");
            const debtTds = debtRow.querySelectorAll(".month-col");
            const balanceTds = balanceRow.querySelectorAll(".month-col");
            const disposableTds = disposableRow.querySelectorAll(".month-col");

            globalConfig.months.forEach((monthKey, idx) => {
                incomeTds[idx].textContent = formatNum(monthStats[monthKey].income);
                expenseTds[idx].textContent = formatNum(monthStats[monthKey].expense);
                debtTds[idx].textContent = formatNum(monthStats[monthKey].debt);
                balanceTds[idx].textContent = formatNum(monthStats[monthKey].balance);
                disposableTds[idx].textContent = formatNum(monthStats[monthKey].disposable);
            });

            // æ›´æ–°æ‰¹é‡æ€»è®¡
            document.getElementById("td-totalIncome").textContent = formatNum(totalIncome);
            document.getElementById("td-totalExpense").textContent = formatNum(totalExpense);
            document.getElementById("td-totalDebt").textContent = formatNum(totalDebt);
            document.getElementById("td-balance").textContent = formatNum(totalBalance);
            document.getElementById("td-disposable").textContent = formatNum(totalDisposable);

            // æ›´æ–°çŠ¶æ€æç¤º
            const balanceStatus = document.getElementById("td-balanceStatus");
            const disposableStatus = document.getElementById("td-disposableStatus");
            if (totalBalance < 0) {
                balanceRow.className = "core-item risk-red";
                balanceStatus.textContent = "æ•´ä½“èµ¤å­—ï¼ˆé£é™©ï¼‰";
            } else {
                balanceRow.className = "core-item safe";
                balanceStatus.textContent = "æ•´ä½“ç›ˆä½™ï¼ˆå®‰å…¨ï¼‰";
            }

            if (totalDisposable < 0) {
                disposableRow.className = "core-item risk-red";
                disposableStatus.textContent = "æ•´ä½“èµ„é‡‘ç¼ºå£ï¼ˆé£é™©ï¼‰";
            } else {
                disposableRow.className = "core-item safe";
                disposableStatus.textContent = "æ•´ä½“èµ„é‡‘å‰©ä½™ï¼ˆå¯å‚¨è“„/æŠ•èµ„ï¼‰";
            }

            // 4. æ›´æ–°å¯è§†åŒ–å¡ç‰‡
            document.getElementById("card-income").textContent = "Â¥ " + formatNum(totalIncome);
            document.getElementById("card-expense").textContent = "Â¥ " + formatNum(totalExpense);
            document.getElementById("card-debt").textContent = "Â¥ " + formatNum(totalDebt);
            document.getElementById("card-disposable").textContent = "Â¥ " + formatNum(totalDisposable);
        }

        // åŠ è½½æ‰¹é‡æœˆä»½æ•°æ®ï¼ˆè·¨å¹´ä»½ï¼‰
        function loadBatchData() {
            const startYear = document.getElementById("start-year").value;
            const startMonth = parseInt(document.getElementById("start-month").value);
            const endYear = document.getElementById("end-year").value;
            const endMonth = parseInt(document.getElementById("end-month").value);

            // æ ¡éªŒï¼šå¼€å§‹å¹´ä»½>ç»“æŸå¹´ä»½ æˆ– åŒä¸€å¹´å¼€å§‹æœˆä»½>ç»“æŸæœˆä»½
            if (parseInt(startYear) > parseInt(endYear) || 
                (parseInt(startYear) === parseInt(endYear) && startMonth > endMonth)) {
                alert("å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´ï¼");
                return;
            }

            globalConfig.startYear = startYear;
            globalConfig.endYear = endYear;
            globalConfig.startMonth = startMonth;
            globalConfig.endMonth = endMonth;

            initMonths();
            updateBatchTip();
            generateMonthColumns();
            generateItemRows();
            calculateAll();
        }

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveData() {
            try {
                localStorage.setItem("salaryPlanData", JSON.stringify(globalConfig));
                alert("æ•°æ®ä¿å­˜æˆåŠŸï¼ä¸‹æ¬¡æ‰“å¼€é¡µé¢å°†è‡ªåŠ¨åŠ è½½è¯¥æ•°æ®");
            } catch (e) {
                alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼š" + e.message);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem("salaryPlanData");
                if (savedData) {
                    globalConfig = JSON.parse(savedData);
                    alert("å·²åŠ è½½æœ¬åœ°ä¿å­˜çš„æ•°æ®");
                }
            } catch (e) {
                console.log("åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥ï¼š", e.message);
            }
        }

        // æ–°å¢æ˜ç»†é¡¹
        function addItem() {
            const typeKey = document.getElementById("select-itemType").value;
            const itemName = document.getElementById("input-itemName").value.trim() || `è‡ªå®šä¹‰${globalConfig.itemTypes[typeKey].name}é¡¹`;
            const isFixed = document.getElementById("select-itemFixed").value;
            const newId = typeKey + Date.now();

            globalConfig.itemTypes[typeKey].items.push({
                id: newId,
                name: itemName,
                isFixed: isFixed,
                planValues: {},
                actualValues: {}
            });

            initMonths();
            generateItemRows();
            calculateAll();
            document.getElementById("input-itemName").value = "";
            alert(`æˆåŠŸæ·»åŠ ã€${itemName}ã€‘æ˜ç»†é¡¹ï¼`);
        }

        // åˆ é™¤æ˜ç»†é¡¹
        function deleteItem(itemId, typeKey, itemName) {
            if (confirm(`ç¡®å®šåˆ é™¤ã€${itemName}ã€‘ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼`)) {
                globalConfig.itemTypes[typeKey].items = globalConfig.itemTypes[typeKey].items.filter(i => i.id !== itemId);
                generateItemRows();
                calculateAll();
                // æ›´æ–°å®é™…æ”¯å‡ºè¡¨æ ¼
                if (globalConfig.currentEditMonth) loadActualExpenseTable();
                alert(`æˆåŠŸåˆ é™¤ã€${itemName}ã€‘æ˜ç»†é¡¹ï¼`);
            }
        }

        // åˆ é™¤é€‰ä¸­æ˜ç»†é¡¹
        function deleteSelectedItem() {
            const selectedTr = document.querySelector("#tbody-items tr[style*='background-color: rgb(233, 240, 245)']");
            if (!selectedTr) {
                alert("è¯·å…ˆç‚¹å‡»æ˜ç»†è¡Œé€‰ä¸­è¦åˆ é™¤çš„é¡¹ï¼");
                return;
            }

            const itemId = selectedTr.dataset.id;
            const typeKey = selectedTr.dataset.type;
            const itemName = selectedTr.querySelector(".item-name-edit").value;
            deleteItem(itemId, typeKey, itemName);
        }

        // æ‰¹é‡å¡«å……è§„åˆ’æ•°æ®
        function doBatchFill() {
            const selectedTr = document.querySelector("#tbody-items tr[style*='background-color: rgb(233, 240, 245)']");
            if (!selectedTr) {
                alert("è¯·å…ˆé€‰ä¸­è¦å¡«å……çš„æ˜ç»†è¡Œï¼");
                return;
            }

            const itemId = selectedTr.dataset.id;
            const typeKey = selectedTr.dataset.type;
            const item = globalConfig.itemTypes[typeKey].items.find(i => i.id === itemId);
            if (!item) return;

            const rule = document.getElementById("select-fillRule").value;
            let fillSuccess = false;

            switch (rule) {
                case "all":
                    const allVal = parseFloat(document.getElementById("input-all").value || 0);
                    if (allVal < 0) { alert("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°ï¼"); return; }
                    globalConfig.months.forEach(monthKey => item.planValues[monthKey] = allVal);
                    fillSuccess = true;
                    break;
                case "odd-even":
                    const oddVal = parseFloat(document.getElementById("input-odd").value || 0);
                    const evenVal = parseFloat(document.getElementById("input-even").value || 0);
                    if (oddVal < 0 || evenVal < 0) { alert("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°ï¼"); return; }
                    globalConfig.months.forEach(monthKey => {
                        const month = parseInt(monthKey.split("-")[1]);
                        item.planValues[monthKey] = month % 2 === 1 ? oddVal : evenVal;
                    });
                    fillSuccess = true;
                    break;
                case "quarter":
                    const q1 = parseFloat(document.getElementById("input-q1").value || 0);
                    const q2 = parseFloat(document.getElementById("input-q2").value || 0);
                    const q3 = parseFloat(document.getElementById("input-q3").value || 0);
                    const q4 = parseFloat(document.getElementById("input-q4").value || 0);
                    if ([q1,q2,q3,q4].some(v => v < 0)) { alert("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°ï¼"); return; }
                    globalConfig.months.forEach(monthKey => {
                        const month = parseInt(monthKey.split("-")[1]);
                        let val = q1;
                        if (month > 3 && month <=6) val = q2;
                        else if (month >6 && month <=9) val = q3;
                        else if (month >9) val = q4;
                        item.planValues[monthKey] = val;
                    });
                    fillSuccess = true;
                    break;
            }

            if (fillSuccess) {
                generateItemRows();
                calculateAll();
                // æ¸…ç©ºè¾“å…¥æ¡†
                ["input-all", "input-odd", "input-even", "input-q1", "input-q2", "input-q3", "input-q4"].forEach(id => {
                    document.getElementById(id).value = "";
                });
                alert(`æˆåŠŸä¸ºã€${item.name}ã€‘æ‰¹é‡å¡«å……è§„åˆ’æ•°æ®ï¼`);
            }
        }

        // åŠ è½½é€‰ä¸­æœˆä»½çš„å®é™…æ”¯å‡ºæ•°æ®
        function loadEditMonthData() {
            const monthKey = document.getElementById("select-editMonth").value;
            if (!monthKey) {
                alert("è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„æœˆä»½ï¼");
                return;
            }
            globalConfig.currentEditMonth = monthKey;
            loadActualExpenseTable();
            alert(`å·²åŠ è½½ã€${monthKey.replace("-", "å¹´")}æœˆã€‘çš„éå›ºå®šé¡¹å®é™…æ”¯å‡ºæ•°æ®ï¼`);
        }

        // ===== PWA å®‰è£…åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰ =====
        let deferredPrompt;
        
        // æ˜¾ç¤ºå®‰è£…æç¤º
        function showInstallPrompt() {
            const prompt = document.getElementById('install-prompt');
            prompt.style.display = 'block';
        }
        
        // éšè—å®‰è£…æç¤º
        function hideInstallPrompt() {
            const prompt = document.getElementById('install-prompt');
            prompt.style.display = 'none';
        }
        
        // æ£€æµ‹æ˜¯å¦ç§»åŠ¨ç«¯
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // æ˜¾ç¤ºç§»åŠ¨ç«¯å·¥å…·æ 
        function showMobileToolbar() {
            if (isMobile()) {
                document.getElementById('mobile-toolbar').style.display = 'block';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            console.log("é¡µé¢å®Œå…¨åŠ è½½ï¼Œåˆå§‹åŒ–åŠŸèƒ½");

            // 1. åŠ è½½æœ¬åœ°ä¿å­˜çš„æ•°æ®
            loadSavedData();

            // 2. åˆå§‹åŒ–æœˆä»½å’Œç•Œé¢
            initMonths();
            updateBatchTip();
            generateMonthColumns();
            generateItemRows();
            calculateAll();
            switchFillPanel();
            loadActualExpenseTable();
            
            // 3. æ˜¾ç¤ºç§»åŠ¨ç«¯å·¥å…·æ 
            showMobileToolbar();

            // 4. ç»‘å®šæŠ˜å æ¨¡å—äº‹ä»¶
            collapseModules.forEach(module => {
                // å¤´éƒ¨ç‚¹å‡»äº‹ä»¶
                document.getElementById(module.headerId).onclick = function() {
                    toggleCollapse(module.contentId, module.btnId);
                };
                // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆé˜»æ­¢å†’æ³¡ï¼‰
                document.getElementById(module.btnId).onclick = function(e) {
                    e.stopPropagation();
                    toggleCollapse(module.contentId, module.btnId);
                };
            });

            // 5. ç»‘å®šå…¶ä»–äº‹ä»¶
            // å¹´ä»½/æœˆä»½é€‰æ‹©å˜åŒ–
            document.getElementById("start-year").onchange = updateBatchTip;
            document.getElementById("start-month").onchange = updateBatchTip;
            document.getElementById("end-year").onchange = updateBatchTip;
            document.getElementById("end-month").onchange = updateBatchTip;
            // åŠ è½½æ‰¹é‡æ•°æ®
            document.getElementById("btn-loadBatch").onclick = loadBatchData;
            // ä¿å­˜æ•°æ®
            document.getElementById("btn-saveData").onclick = saveData;
            // å¡«å……è§„åˆ™å˜åŒ–
            document.getElementById("select-fillRule").onchange = switchFillPanel;
            // æ‰§è¡Œæ‰¹é‡å¡«å……
            document.getElementById("btn-doFill").onclick = doBatchFill;
            // æ–°å¢æ˜ç»†
            document.getElementById("btn-addItem").onclick = addItem;
            // åˆ é™¤é€‰ä¸­æ˜ç»†
            document.getElementById("btn-delItem").onclick = deleteSelectedItem;
            // åŠ è½½ç¼–è¾‘æœˆä»½æ•°æ®
            document.getElementById("btn-loadEditMonth").onclick = loadEditMonthData;
            // ä¸€é”®å¡«å……å®é™…åˆ°è§„åˆ’
            document.getElementById("btn-fillToPlan").onclick = fillActualToPlan;
            
            // 6. PWA å®‰è£…äº‹ä»¶ç»‘å®š
            document.getElementById('install-btn').onclick = function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(choiceResult => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('ç”¨æˆ·åŒæ„å®‰è£…');
                        }
                        deferredPrompt = null;
                        hideInstallPrompt();
                    });
                }
            };
            
            document.getElementById('close-prompt').onclick = hideInstallPrompt;
            
            // 7. ç›‘å¬PWAå®‰è£…äº‹ä»¶
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // æ˜¾ç¤ºå®‰è£…æŒ‰é’®
                setTimeout(showInstallPrompt, 3000);
            });

            console.log("åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ");
        };
    </script>
    
    <!-- ================= PWA Service Worker æ³¨å†Œ ================= -->
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(() => console.log('PWA Service Worker æ³¨å†ŒæˆåŠŸ'))
                .catch(err => console.error('Service Worker æ³¨å†Œå¤±è´¥', err));
        });
    }
    </script>
</body>
</html>